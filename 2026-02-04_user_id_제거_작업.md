# 2026-02-04 user_id 제거 작업

## 마이그레이션
- `007_remove_user_id.sql` 생성 (005 통합)
  - ad_archive_id 컬럼 추가 및 인덱스 생성 (005에서 통합)
  - RLS 정책 제거
  - UNIQUE constraint 변경: `(platform, ad_archive_id, user_id)` → `(platform, ad_archive_id)`
  - user_id 컬럼 삭제: ad_archives, scrape_jobs, user_search_history
  - user_id 인덱스 제거

## 백엔드 수정

### metaAdLibrary.js
- `scrapeMetaAds()` 함수: userId 파라미터 제거
- `saveAdToSupabase()` 함수: userId 파라미터 제거, user_id 필드 제거
- upsert onConflict: `'platform,ad_archive_id,user_id'` → `'platform,ad_archive_id'`

### scrapeRoutes.js
- `/keyword`, `/advertiser` 엔드포인트: userId 변수 제거
- `addScrapeJob()` 호출: userId 전달 제거
- `createJob()` 호출: userId 파라미터 제거
- `user_search_history` insert: user_id 필드 제거

### scrapeQueue.js
- `addScrapeJob()` 함수: userId 파라미터 제거
- job.data: userId 제거
- `scrapeMetaAds()` 호출: userId 전달 제거

### dbService.js
- `saveAd()` 함수: userId 파라미터 제거, user_id 필드 제거
- `createJob()` 함수: userId 파라미터 제거, user_id 필드 제거

### jobRoutes.js
- `GET /:jobId`: user_id 필터링 제거
- `GET /`: user_id 필터링 제거

### auth.js
- 개발 환경 우회: 하드코딩된 user_id 제거

## 문서 수정

### PLAYWRIGHT_스크랭핑.md
- Line 341: UNIQUE constraint 예시에서 user_id 제거
- Line 362: UNIQUE constraint 설명에서 user_id 제거

## 마이그레이션 정리

### 대체된 파일 (renamed to _DEPRECATED_)
- `_DEPRECATED_002_row_level_security.sql` - RLS 정책 생성, 007에서 모두 제거
- `_DEPRECATED_005_fix_ad_archive_id_uniqueness.sql` - ad_archive_id 컬럼 생성 + 구 constraint, 007로 통합
- `_DEPRECATED_006_fix_unique_constraint.sql` - user_id 포함 constraint 생성, 007에서 user_id 없이 재생성

### 유효한 마이그레이션
- `001_create_tables.sql` - 초기 테이블 생성
- `003_add_link_url.sql` - link_url 필드 추가
- `004_add_cloudinary_ocr_fields.sql` - Cloudinary 필드 추가
- `007_remove_user_id.sql` - ad_archive_id 추가 + user_id 제거 (통합본)
