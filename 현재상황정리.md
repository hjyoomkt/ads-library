# ì´ˆëŒ€ ì½”ë“œ íšŒì›ê°€ì… 403 ì˜¤ë¥˜ - ê²€ì¦ëœ ì‚¬ì‹¤ ì •ë¦¬

## ê²€ì¦ ì™„ë£Œëœ ì‚¬ì‹¤

### 1. ì´ˆëŒ€ ì½”ë“œ (âœ… ì •ìƒ)
```sql
SELECT * FROM invitation_codes WHERE code = 'hj1wzxl4f4icri9i639jw';
```
- code: hj1wzxl4f4icri9i639jw
- invited_email: test99@zestdot.com
- role: agency_admin
- invite_type: new_agency
- expires_at: 2026-02-11 (ìœ íš¨)
- used_by: null (ë¯¸ì‚¬ìš©)

### 2. RLS ì •ì±… (âœ… ì¡´ì¬í•˜ê³  ì˜¬ë°”ë¦„)
```sql
-- organizations INSERT ì •ì±… í™•ì¸
SELECT pol.polname, pg_get_expr(pol.polwithcheck, pol.polrelid) as with_check_clause
FROM pg_policy pol
JOIN pg_class c ON c.oid = pol.polrelid
WHERE c.relname = 'organizations' AND pol.polcmd = 'a';
```
**ê²°ê³¼:**
- policyname: `authenticated_insert_organizations`
- with_check: `true`

**ì˜ë¯¸:** ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ë¬´ì¡°ê±´ INSERT í—ˆìš©ë˜ì–´ì•¼ í•¨

### 3. users SELECT ì •ì±… (âœ… ë¬´í•œ ì¬ê·€ ìˆ˜ì • ì™„ë£Œ)
```sql
SELECT pol.polname, pg_get_expr(pol.polqual, pol.polrelid) as using_clause
FROM pg_policy pol
JOIN pg_class c ON c.oid = pol.polrelid
WHERE c.relname = 'users' AND pol.polcmd = 'r';
```
**ê²°ê³¼:**
```sql
(advertiser_id IN (SELECT get_user_advertiser_ids_by_uid(auth.uid())) OR (id = auth.uid()))
```

### 4. íšŒì›ê°€ì… í”Œë¡œìš° (âœ… ì„¸ì…˜ê¹Œì§€ëŠ” ì •ìƒ)
**ë¸Œë¼ìš°ì € ì½˜ì†” ë¡œê·¸:**
```
âœ… Auth ê³„ì • ìƒì„± ì„±ê³µ:
   user_id: 2200ca38-1347-44de-ae72-9704a4e554e0
   session: ì„¸ì…˜ ìˆìŒ

ğŸ” ì„¸ì…˜ ì¬ì„¤ì • ì‹œì‘
ğŸ” í˜„ì¬ ì„¸ì…˜ ìƒíƒœ:
   hasSession: true
   accessToken: í† í° ìˆìŒ

âœ… ì„¸ì…˜ ì¬ì„¤ì • ì™„ë£Œ

ğŸ“ ì‹ ê·œ ëŒ€í–‰ì‚¬ ì¡°ì§ ìƒì„± ì‹œë„:
   name: 123123
   type: agency

âŒ POST /organizations â†’ 403 Forbidden
```

**ì—ëŸ¬:**
```
code: '42501'
message: 'new row violates row-level security policy for table "organizations"'
```

### 5. service_roleë¡œ INSERT (âœ… ì„±ê³µ)
```javascript
node test_with_service_role.js
```
**ê²°ê³¼:** âœ… INSERT ì„±ê³µ

**ì˜ë¯¸:**
- RLS ì •ì±… ìì²´ëŠ” ì‘ë™í•¨
- RLS ìš°íšŒí•˜ë©´ INSERT ê°€ëŠ¥
- ë¬¸ì œëŠ” authenticated role ì¸ì¦

## ëª¨ìˆœë˜ëŠ” ìƒí™©

### ì •ì±…ì€ ìˆì§€ë§Œ ì ìš© ì•ˆ ë¨
1. **ì •ì±…:** `WITH CHECK (true)` - ì¸ì¦ëœ ì‚¬ìš©ì ë¬´ì¡°ê±´ í—ˆìš©
2. **ì‹¤ì œ:** 403 Forbidden ë°œìƒ

### ì„¸ì…˜ì€ ìˆì§€ë§Œ ì¸ì¦ ì‹¤íŒ¨
1. **í™•ì¸:** ì½˜ì†”ì—ì„œ `hasSession: true`, `accessToken: í† í° ìˆìŒ`
2. **ê²°ê³¼:** ì—¬ì „íˆ RLS ìœ„ë°˜

## ì‹œë„í•œ í•´ê²° ë°©ë²• (ëª¨ë‘ ì‹¤íŒ¨)

1. âœ… RLS ì •ì±… ìƒì„± (apply_signup_fix.sql)
2. âœ… users SELECT ì •ì±… ìˆ˜ì • (ë¬´í•œ ì¬ê·€ ì œê±°)
3. âœ… ì„¸ì…˜ ëª…ì‹œì  ì¬ì„¤ì • (setSession)
4. âœ… PostgREST ìºì‹œ ìƒˆë¡œê³ ì¹¨ (NOTIFY pgrst, 'reload schema')
5. âœ… apply_signup_fix.sql ì¬ì‹¤í–‰

**ê²°ê³¼: ëª¨ë‘ 403 ì—¬ì „íˆ ë°œìƒ**

## ë¯¸ê²€ì¦ ì‚¬í•­

### HTTP ìš”ì²­ Authorization í—¤ë”
**í™•ì¸ í•„ìš”:**
```
POST https://qpeflgaxnavvogsodjlq.supabase.co/rest/v1/organizations
```

**Request Headersì—:**
- `Authorization: Bearer <JWT í† í°>` ìˆëŠ”ì§€?
- ì•„ë‹ˆë©´ `Authorization: Bearer <anon_key>`ì¸ì§€?

### JWT í† í°ì˜ role claim
**í™•ì¸ í•„ìš”:**
- ì‹¤ì œ JWT í† í°ì„ decodeí•´ì„œ roleì´ `authenticated`ì¸ì§€ í™•ì¸

## ë‹¤ìŒ ê²€ì¦ ë‹¨ê³„

### í•„ìˆ˜: Network íƒ­ì—ì„œ ì‹¤ì œ HTTP ìš”ì²­ í™•ì¸
1. F12 â†’ Network íƒ­
2. íšŒì›ê°€ì… ì‹œë„
3. `POST /organizations` ìš”ì²­ ì„ íƒ
4. **Request Headers â†’ Authorization** í™•ì¸

**ì˜ˆìƒ:**
- ìˆìŒ: `Authorization: Bearer eyJ...` (JWT í† í°)
- ì—†ìŒ ë˜ëŠ” anon key â†’ **ì´ê²ƒì´ ë¬¸ì œ**

### ì„ íƒ: Supabase í”„ë¡œì íŠ¸ ì¬ì‹œì‘
PostgREST ìºì‹œê°€ ì™„ì „íˆ ê°±ì‹ ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŒ
- Supabase Dashboard â†’ Project Settings â†’ Pause Project
- ì ì‹œ ëŒ€ê¸° í›„ Resume

## í•µì‹¬ ì˜ë¬¸

**ì™œ ì„¸ì…˜ì´ ìˆëŠ”ë°ë„ RLS ì •ì±…ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ê°€?**

ê°€ëŠ¥í•œ ì›ì¸:
1. Supabase JS í´ë¼ì´ì–¸íŠ¸ê°€ HTTP ìš”ì²­ì— Authorization í—¤ë”ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŒ
2. PostgRESTê°€ ì •ì±… ë³€ê²½ì„ ì¸ì‹í•˜ì§€ ëª»í•¨ (ìºì‹œ ë¬¸ì œ)
3. JWT í† í°ì˜ role claimì´ `authenticated`ê°€ ì•„ë‹˜
