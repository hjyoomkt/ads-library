# ë°ì´í„° ìˆ˜ì§‘ & ë¶ë§ˆí¬ ì‹œìŠ¤í…œ ì •ë¦¬

## ğŸ“Œ í•µì‹¬ ê°œë…

### 1. ë°ì´í„° êµ¬ì¡°
- **ad_archives (ê´‘ê³  ë°ì´í„°)**: ì„œë²„ ê·€ì†, ëª¨ë“  ë¸Œëœë“œ ê³µìœ 
- **user_search_history (ê²€ìƒ‰ ë¶ë§ˆí¬)**: ë¸Œëœë“œë³„ ê²©ë¦¬

### 2. ì‹œìŠ¤í…œ ë¶„ë¦¬
- **ë°±ì—”ë“œ**: ìŠ¤í¬ë˜í•‘ë§Œ ë‹´ë‹¹ (ì‚¬ìš©ì/ë¸Œëœë“œ ì •ë³´ ë¶ˆí•„ìš”)
- **í”„ë¡ íŠ¸ì—”ë“œ**: ê²€ìƒ‰ ë¶ë§ˆí¬ ê´€ë¦¬

---

## ğŸ”„ ë°ì´í„° ìˆ˜ì§‘ íë¦„

### ê²€ìƒ‰ ì‹œì‘
```
1. ì‚¬ìš©ìê°€ ê²€ìƒ‰ì–´ ì…ë ¥ ("ì‹œì›ìŠ¤ì¿¨")
2. POST /api/scrape/keyword â†’ ë°±ì—”ë“œ ìŠ¤í¬ë˜í•‘ ì‹œì‘
3. Bull Queueì— Job ì¶”ê°€
4. JobTrackerê°€ ì§„í–‰ ìƒí™© ì‹¤ì‹œê°„ í‘œì‹œ
```

### ìŠ¤í¬ë˜í•‘ ì²˜ë¦¬
```
1. Playwrightë¡œ Meta Ad Library ì ‘ì†
2. ê´‘ê³  ë°ì´í„° ìˆ˜ì§‘
3. ad_archives í…Œì´ë¸”ì— ì €ì¥ (UPSERT)
   - UNIQUE ì œì•½: (platform, advertiser_name, ad_creative_body, started_running_date)
   - ì¤‘ë³µ ê´‘ê³  â†’ UPDATE
   - ì‹ ê·œ ê´‘ê³  â†’ INSERT
```

### Cloudinary ì—…ë¡œë“œ ë¡œì§
```
uploadToCloudinary = true (í™œì„±í™”)

IF ê´‘ê³ ê°€ DBì— ì´ë¯¸ ì¡´ì¬:
  IF ad_mediaì— cloudinary_public_id ì¡´ì¬:
    âœ… ì¬ì‚¬ìš© (ì¬ì—…ë¡œë“œ ì•ˆ í•¨)
  ELSE:
    ìƒˆë¡œ ì—…ë¡œë“œ
ELSE:
  ìƒˆ ê´‘ê³  â†’ ë¬´ì¡°ê±´ ì—…ë¡œë“œ
```

---

## ğŸ”– ë¶ë§ˆí¬ ì‹œìŠ¤í…œ (ìˆ˜ì • ì™„ë£Œ)

### ë¬¸ì œ ìƒí™© (ìˆ˜ì • ì „)
```
âŒ ë°±ì—”ë“œê°€ ê²€ìƒ‰ íˆìŠ¤í† ë¦¬ ì €ì¥
âŒ ê³ ì •ëœ advertiser_id ì‚¬ìš© (req.user.advertiserId = Default Brand)
âŒ ë¸Œëœë“œ ì „í™˜í•´ë„ ëª¨ë‘ Default Brandë¡œ ì €ì¥ë¨
```

### í•´ê²° ë°©ì•ˆ (ìˆ˜ì • í›„)
```
âœ… ë°±ì—”ë“œ: user_search_history INSERT ì œê±°
âœ… í”„ë¡ íŠ¸ì—”ë“œ: ê²€ìƒ‰ í›„ ì§ì ‘ ì €ì¥ (currentAdvertiserId ì‚¬ìš©)
âœ… ë¸Œëœë“œë³„ë¡œ ì •í™•í•˜ê²Œ ë¶„ë¦¬
```

### ë¶ë§ˆí¬ ì €ì¥ íë¦„
```
1. SearchBarì—ì„œ ê²€ìƒ‰ ìˆ˜í–‰
2. ë°±ì—”ë“œ ìŠ¤í¬ë˜í•‘ ì‹œì‘ (ê´‘ê³  ìˆ˜ì§‘ë§Œ)
3. í”„ë¡ íŠ¸ì—”ë“œê°€ ì¦‰ì‹œ saveSearchHistory() í˜¸ì¶œ
   - searchType: 'keyword' or 'advertiser'
   - searchQuery: "ì‹œì›ìŠ¤ì¿¨"
   - advertiserId: currentAdvertiserId (í˜„ì¬ ì„ íƒëœ ë¸Œëœë“œ)
4. user_search_historyì— INSERT
5. SavedSearchesSidebar ìë™ ìƒˆë¡œê³ ì¹¨
```

### ë¶ë§ˆí¬ ì¡°íšŒ íë¦„
```
1. getSearchHistory() í˜¸ì¶œ (Supabase ì§ì ‘ ì¿¼ë¦¬)
2. RLS ì •ì±… ìë™ ì ìš©
   - advertiser_id IN (SELECT get_user_advertiser_ids_by_uid(auth.uid()))
3. ì—­í• ë³„ í•„í„°ë§:
   - Master: ëª¨ë“  ë¸Œëœë“œì˜ ê²€ìƒ‰ ì¡°íšŒ
   - Agency: ê°™ì€ ì¡°ì§ì˜ ë¸Œëœë“œ ê²€ìƒ‰ ì¡°íšŒ
   - Advertiser: ìì‹ ì˜ ë¸Œëœë“œ ê²€ìƒ‰ë§Œ ì¡°íšŒ
4. SavedSearchesSidebarì— í‘œì‹œ
```

---

## ğŸ“Š ë°ì´í„° íë¦„ ë‹¤ì´ì–´ê·¸ë¨

### íƒ€ ë¸Œëœë“œê°€ ê°™ì€ í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹œ
```
ë¸Œëœë“œ A: "ì‹œì›ìŠ¤ì¿¨" ê²€ìƒ‰
  â†’ ad_archives: 69ê°œ ê´‘ê³  (ê³µìœ  ë°ì´í„°)
  â†’ user_search_history: 1ê°œ row (advertiser_id = ë¸Œëœë“œ A)

ë¸Œëœë“œ B: "ì‹œì›ìŠ¤ì¿¨" ê²€ìƒ‰ (ê°™ì€ í‚¤ì›Œë“œ!)
  â†’ ad_archives: ì¤‘ë³µ ê´‘ê³  UPSERT, ì‹ ê·œë§Œ INSERT
  â†’ user_search_history: 1ê°œ row (advertiser_id = ë¸Œëœë“œ B)

ê²°ê³¼:
- ad_archives: ëª¨ë“  ë¸Œëœë“œê°€ ë™ì¼í•œ 69ê°œ ê´‘ê³  ì¡°íšŒ (ì„œë²„ ê·€ì†)
- user_search_history: ê° ë¸Œëœë“œë³„ë¡œ 1ê°œì”© ë…ë¦½ì ìœ¼ë¡œ ì €ì¥ (ë¶ë§ˆí¬)
```

---

## ğŸ”‘ í•µì‹¬ ë³€ê²½ íŒŒì¼

### ë°±ì—”ë“œ (3ê°œ)
1. **scrapeRoutes.js**
   - `user_search_history` INSERT ì œê±°
   - `createJob()`ì—ì„œ `advertiser_id` íŒŒë¼ë¯¸í„° ì œê±°

2. **dbService.js**
   - `createJob()` í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ë³€ê²½: `advertiserId` íŒŒë¼ë¯¸í„° ì œê±°

3. **scrapeQueue.js**
   - ë³€ê²½ ì—†ìŒ (uploadToCloudinary = true ìœ ì§€)

### í”„ë¡ íŠ¸ì—”ë“œ (3ê°œ)
1. **supabaseService.js**
   - `saveSearchHistory()` í•¨ìˆ˜ ì¶”ê°€
   - ì¤‘ë³µ ì—ëŸ¬ ì²˜ë¦¬ (23505)

2. **SearchBar.jsx**
   - `useAuth` í›… ì¶”ê°€ â†’ `currentAdvertiserId` ê°€ì ¸ì˜¤ê¸°
   - ê²€ìƒ‰ í›„ `saveSearchHistory()` í˜¸ì¶œ

3. **apiService.js**
   - `saveSearchHistory` export ì¶”ê°€

---

## âœ… ê²€ì¦ ì™„ë£Œ

### ë°ì´í„° ê²€ì¦
```
í…ŒìŠ¤íŠ¸ë¸Œëœë“œì—ì„œ "ìºë¦¬ë°•ìŠ¤" ê²€ìƒ‰:
âœ… DB ì €ì¥: advertiser_id = c4f9dc7b... (í…ŒìŠ¤íŠ¸ë¸Œëœë“œ)
âœ… Default Brandì—ì„œ ì¡°íšŒ: ì•ˆ ë³´ì„ (RLS í•„í„°ë§)
âœ… í…ŒìŠ¤íŠ¸ë¸Œëœë“œì—ì„œ ì¡°íšŒ: ë³´ì„
âœ… Master ê¶Œí•œ: ëª¨ë“  ë¸Œëœë“œ ê²€ìƒ‰ ì¡°íšŒ ê°€ëŠ¥
```

### ì¤‘ë³µ ë°©ì§€
```
í˜„ì¬: INSERT ë°©ì‹ (ì¤‘ë³µ í—ˆìš©)
ê°œì„  ê°€ëŠ¥: UPSERT ë°©ì‹ (UNIQUE ì œì•½ ì¶”ê°€)
  - UNIQUE(advertiser_id, search_type, search_query)
  - ê°™ì€ ê²€ìƒ‰ì–´ ì—¬ëŸ¬ ë²ˆ â†’ created_atë§Œ ì—…ë°ì´íŠ¸
```

---

## ğŸ“ í–¥í›„ ê°œì„  ì‚¬í•­

### 1. ì¤‘ë³µ ë°©ì§€ (ì„ íƒ)
```sql
ALTER TABLE user_search_history
ADD CONSTRAINT unique_search_per_brand
UNIQUE(advertiser_id, search_type, search_query);
```

### 2. ë¶ë§ˆí¬ ì‚­ì œ ê¸°ëŠ¥ (ì„ íƒ)
```javascript
// SavedSearchesSidebarì— ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
await supabase
  .from('user_search_history')
  .delete()
  .match({ id: searchHistoryId });
```

### 3. ë§ˆì§€ë§‰ ê²€ìƒ‰ ì‹œê°„ ì¶”ì  (ì„ íƒ)
```sql
ALTER TABLE user_search_history
ADD COLUMN updated_at TIMESTAMP DEFAULT NOW();

-- UPSERT ì‹œ updated_at ìë™ ê°±ì‹ 
```

---

## ğŸ¯ ìš”ì•½

### ë³€ê²½ ì „
- ë°±ì—”ë“œê°€ ëª¨ë“  ê²€ìƒ‰ì„ Default Brandë¡œ ì €ì¥
- ë¸Œëœë“œ ì „í™˜í•´ë„ ì†Œìš©ì—†ìŒ

### ë³€ê²½ í›„
- í”„ë¡ íŠ¸ì—”ë“œê°€ í˜„ì¬ ì„ íƒëœ ë¸Œëœë“œë¡œ ì €ì¥
- ë¸Œëœë“œë³„ë¡œ ì •í™•í•˜ê²Œ ë¶„ë¦¬ë¨
- RLSë¡œ ìë™ í•„í„°ë§

### í•µì‹¬
- **ê´‘ê³  ë°ì´í„°**: ì„œë²„ ê·€ì† (ê³µìœ )
- **ê²€ìƒ‰ ë¶ë§ˆí¬**: ë¸Œëœë“œ ì†Œìœ  (ê²©ë¦¬)
- **ë¶ë§ˆí¬**: ê²€ìƒ‰í•˜ë©´ ìë™ ì €ì¥ (ëª…ì‹œì  ë²„íŠ¼ ì—†ìŒ)
